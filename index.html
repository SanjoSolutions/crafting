<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Crafting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      #things .row {
        margin-bottom: 0.5rem;
      }

      #things .thing {
        margin-right: 0.5rem;
      }

      .thing {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid black;
        padding: 0.25rem;
        width: 4rem;
        height: 4rem;
        cursor: pointer;
        user-select: none;
      }
    </style>
  </head>
  <body>
    <template id="thing">
      <div class="thing"></div>
    </template>

    <div id="things"></div>

    <script type="module">
      import { createThings, createThingsMadeOutOfThings } from './index.js'

      const recipes = new Map()
      const inventory = new Map()
      const nameToThing = new Map()
      const thingToNode = new Map()
      const rows = []
      const thingToRow = new Map()

      const $things = document.querySelector('#things')

      const things = createThings(5)

      const thingTemplate = document.querySelector('#thing')

      const $row = document.createElement('div')
      $row.className = 'row'

      for (const thing of things) {
        nameToThing.set(thing.name, thing)

        const $thing = thingTemplate.content.cloneNode(true)
        $thing.querySelector('.thing').textContent = thing.name + ` (${ inventory.get(thing) ?? 0 })`
        thingToNode.set(thing, $thing.querySelector('.thing'))
        $row.appendChild($thing)
      }
      const row = things
      rows.push(row)
      row.map(thing => thingToRow.set(thing, row))
      $things.appendChild($row)

      function createThingsMadeOutOfThings2(things) {
        const thingsMadeOutOfThings = createThingsMadeOutOfThings(
          things,
          3,
          {
            minimumIngredients: 2,
            maximumIngredients: 3,
            minimumAmount: 1,
            maximumAmount: 5
          }
        )

        const $row = document.createElement('div')
        $row.className = 'row'

        for (const thing of thingsMadeOutOfThings) {
          nameToThing.set(thing.thing.name, thing.thing)
          recipes.set(thing.thing, thing.recipe)

          const $thing = thingTemplate.content.cloneNode(true)
          $thing.querySelector('.thing').textContent = thing.thing.name + ` (${ inventory.get(thing.thing) ?? 0 })`
          $thing.querySelector('.thing').title =
            'Ingredients: ' +
            thing.recipe.ingredients.map(ingredient => `${ ingredient.quantity } x ${ ingredient.thing.name }`)
              .join(', ')
          thingToNode.set(thing.thing, $thing.querySelector('.thing'))
          $row.appendChild($thing)
        }
        const row = thingsMadeOutOfThings.map(({ thing }) => thing)
        rows.push(row)
        row.map(thing => thingToRow.set(thing, row))
        $things.appendChild($row)
      }

      createThingsMadeOutOfThings2(things)

      $things.addEventListener('click', function onClick(event) {
        const { target } = event
        if (target.classList.contains('thing')) {
          const $thing = target
          const name = $thing.textContent.split(' ')[0]
          const thing = nameToThing.get(name)

          if (isMadeOutOfOtherThings(thing)) {
            const recipe = recipes.get(thing)
            if (areAllIngredientsAvailableInInventory(recipe)) {
              removeIngredientsFromInventory(recipe)
              for (const ingredient of recipe.ingredients) {
                updateThingUI(ingredient.thing)
              }
              const quantity = inventory.get(thing) ?? 0
              inventory.set(thing, quantity + 1)
              $thing.textContent = thing.name + ` (${ inventory.get(thing) ?? 0 })`
              const row = thingToRow.get(thing)
              if (isFirstThingMadeFromRow(row)) {
                createThingsMadeOutOfThings2(row)
              }
            }
          } else {
            const quantity = inventory.get(thing) ?? 0
            inventory.set(thing, quantity + 1)
            $thing.textContent = thing.name + ` (${ inventory.get(thing) ?? 0 })`
          }
        }
      })

      function isMadeOutOfOtherThings(thing) {
        return recipes.has(thing)
      }

      function areAllIngredientsAvailableInInventory(recipe) {
        return recipe.ingredients.every(ingredient => inventory.get(ingredient.thing) >= ingredient.quantity)
      }

      function removeIngredientsFromInventory(recipe) {
        for (const ingredient of recipe.ingredients) {
          inventory.set(ingredient.thing, inventory.get(ingredient.thing) - ingredient.quantity)
        }
      }

      function updateThingUI(thing) {
        const $thing = thingToNode.get(thing)
        $thing.textContent = thing.name + ` (${ inventory.get(thing) ?? 0 })`
      }

      function isFirstThingMadeFromRow(row) {
        return sum(row.map(thing => inventory.get(thing) ?? 0)) === 1
      }

      function sum(values) {
        return values.reduce(plus)
      }

      function plus(a, b) {
        return a + b
      }
    </script>
  </body>
</html>
